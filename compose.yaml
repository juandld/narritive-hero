services:
  backend:
    build: ./backend
    env_file:
      - ./backend/.env
      - ./.env
    environment:
      # Ensure backend writes to the bind mount inside the container
      - STORAGE_DIR=/app/storage
    ports:
      - "${BACKEND_PORT:-8000}:8000"
    volumes:
      # Bind mount the entire storage directory. Set STORAGE_DIR to an absolute path on your VPS for durability,
      # e.g., STORAGE_DIR=/var/lib/narrative-hero (falls back to ./storage when unset)
      - ${STORAGE_DIR:-./storage}:/app/storage

  frontend:
    build:
      context: ./frontend
      args:
        # Pass through if set; leave empty to enable same-origin fallback (port 80/443)
        - VITE_BACKEND_URL=${VITE_BACKEND_URL:-}
    ports:
      - "${FRONTEND_PORT:-80}:80"
    depends_on:
      - backend

  cloudflared:
    image: cloudflare/cloudflared:latest
    restart: unless-stopped
    command: tunnel --no-autoupdate run --token ${CLOUDFLARE_TUNNEL_TOKEN}
    environment:
      - TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN}
    depends_on:
      - frontend
      - backend
