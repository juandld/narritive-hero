services:
  backend:
    build: ./backend
    env_file:
      - ./backend/.env
      - ./.env
    environment:
      # Ensure backend writes to the bind mount inside the container
      - STORAGE_DIR=/app/storage
    ports:
      - "${BACKEND_PORT:-8000}:8000"
    volumes:
      # Bind mount the entire storage directory. Set STORAGE_DIR to an absolute path on your VPS for durability,
      # e.g., STORAGE_DIR=/var/lib/narrative-hero (falls back to ./storage when unset)
      - ${STORAGE_DIR:-./storage}:/app/storage

  frontend:
    build:
      context: ./frontend
      args:
        # Pass through if set; leave empty to enable same-origin fallback (port 80/443)
        - VITE_BACKEND_URL=${VITE_BACKEND_URL:-}
    ports:
      - "${FRONTEND_PORT:-80}:80"
    depends_on:
      - backend

  cloudflared:
    image: cloudflare/cloudflared:latest
    restart: unless-stopped
    command: tunnel --no-autoupdate run --token ${CLOUDFLARE_TUNNEL_TOKEN}
    environment:
      - TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN}
    depends_on:
      - frontend
      - backend

  appwrite:
    image: appwrite/appwrite:1.5.0
    restart: unless-stopped
    environment:
      - _APP_ENV=development
      - _APP_OPENSSL_KEY_V1=${APPWRITE_OPENSSL_KEY_V1:-changeme}
      - _APP_DOMAIN=${APPWRITE_DOMAIN:-localhost}
      - _APP_DOMAIN_TARGET=${APPWRITE_DOMAIN_TARGET:-localhost}
      - _APP_STORAGE_LIMIT=2000000000
      - _APP_SYSTEM_RESPONSE_FORMAT=${APPWRITE_RESPONSE_FORMAT:-1.5.0}
      - _APP_DB_HOST=${APPWRITE_DB_HOST:-mariadb}
      - _APP_DB_PORT=${APPWRITE_DB_PORT:-3306}
      - _APP_DB_SCHEMA=${APPWRITE_DB_SCHEMA:-appwrite}
      - _APP_DB_USER=${APPWRITE_DB_USER:-root}
      - _APP_DB_PASS=${APPWRITE_DB_PASSWORD:-root}
      - _APP_DB_ROOT_PASS=${APPWRITE_DB_PASSWORD:-root}
      - _APP_REDIS_HOST=${APPWRITE_REDIS_HOST:-redis}
      - _APP_REDIS_PORT=${APPWRITE_REDIS_PORT:-6379}
    ports:
      - "${APPWRITE_PORT:-8080}:80"
    volumes:
      - appwrite-data:/storage
      - appwrite-config:/etc/appwrite
    depends_on:
      - mariadb
      - redis
      - smtp
      - clamav

  appwrite-worker-databases:
    image: appwrite/appwrite:1.5.0
    entrypoint: worker-databases
    restart: unless-stopped
    environment:
      - _APP_ENV=development
      - _APP_OPENSSL_KEY_V1=${APPWRITE_OPENSSL_KEY_V1:-changeme}
      - _APP_DOMAIN=${APPWRITE_DOMAIN:-localhost}
      - _APP_DB_HOST=${APPWRITE_DB_HOST:-mariadb}
      - _APP_DB_PORT=${APPWRITE_DB_PORT:-3306}
      - _APP_DB_SCHEMA=${APPWRITE_DB_SCHEMA:-appwrite}
      - _APP_DB_USER=${APPWRITE_DB_USER:-root}
      - _APP_DB_PASS=${APPWRITE_DB_PASSWORD:-root}
      - _APP_DB_ROOT_PASS=${APPWRITE_DB_PASSWORD:-root}
      - _APP_REDIS_HOST=${APPWRITE_REDIS_HOST:-redis}
      - _APP_REDIS_PORT=${APPWRITE_REDIS_PORT:-6379}
    depends_on:
      - mariadb
      - redis

  mariadb:
    image: mariadb:11
    restart: unless-stopped
    environment:
      - MYSQL_ROOT_PASSWORD=${APPWRITE_DB_PASSWORD:-root}
    volumes:
      - appwrite-mariadb:/var/lib/mysql

  redis:
    image: redis:7-alpine
    restart: unless-stopped
    volumes:
      - appwrite-redis:/data

  smtp:
    image: mailhog/mailhog:latest
    restart: unless-stopped
    ports:
      - "1025:1025"
      - "8025:8025"

  clamav:
    image: mkodockx/docker-clamav:alpine
    restart: unless-stopped

volumes:
  appwrite-data:
  appwrite-config:
  appwrite-mariadb:
  appwrite-redis:
